{% extends "base.html" %}

{% block title %}Westeros Map{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="text-center mb-4">Westeros Map</h2>

        <div id="map-container"></div>

        <div class="mt-3">
            <small class="text-muted">Click on a castle icon for more info</small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Map initialization
    const map = L.map('map-container', {
        crs: L.CRS.Simple,
        minZoom: 0,
        maxZoom: 5
    });

    const imgWidth = 500;
    const imgHeight = 800;

    const imageBounds = [
        [0, 0],
        [imgHeight, imgWidth]
    ];

    map.setView([imgHeight/2, imgWidth/2], 1);

    const imageUrl = "{{ url_for('static', filename='images/westeros-map.png') }}";
    L.imageOverlay(imageUrl, imageBounds).addTo(map);

    function pixelToLatLng(x, y) {
        return [imgHeight - y, x];
    }

    // Castle markers
    const castles = [
        {% for house in houses %}
        {
            name: "{{ house.seat.name if house.seat else '' }}",
            house: "{{ house.name }}",
            pixelX: {{ house.seat.location.split(',')[0].strip() if house.seat and house.seat.location else 0 }},
            pixelY: {{ house.seat.location.split(',')[1].strip() if house.seat and house.seat.location else 0 }},
            image: "{{ url_for('static', filename='images/' + house.emblem) }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    // Adding markers
    castles.forEach(castle => {
        const coords = pixelToLatLng(castle.pixelX, castle.pixelY);
        const marker = L.marker(coords, {
            icon: L.divIcon({
                html: 'üè∞',
                className: 'castle-icon',
                iconSize: [30, 30]
            })
        }).addTo(map);

        marker.bindPopup(`
            <div class="castle-popup">
                <h5>${castle.name}</h5>
                <p>House: <a href="/house/${castle.house}" target="_blank">${castle.house}</a>s</p>
                <img src="${castle.image}" alt="${castle.house}">
            </div>
        `);
    });
</script>
{% endblock %}